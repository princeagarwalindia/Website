<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dino Game</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f0f0f0;
    }
    #game {
      width: 600px;
      height: 200px;
      border: 2px solid black;
      background: white;
      position: relative;
      overflow: hidden;
    }
    #player {
      width: 40px;
      height: 40px;
      background: black;
      position: absolute;
      left: 50px;
      bottom: 0;
    }
    #obstacle {
      width: 20px;
      height: 40px;
      background: red;
      position: absolute;
      bottom: 0;
      right: 0;
    }
    canvas {
      margin-top: 20px;
    }
    #message {
      margin-top: 10px;
      font-size: 18px;
      color: darkred;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <h1>Dino Game</h1>
  <div id="game">
    <div id="player"></div>
    <div id="obstacle"></div>
  </div>
  <canvas id="qr"></canvas>
  <div id="message">Scan this QR on your phone to play!</div>

  <script>
    const player = document.getElementById("player");
    const obstacle = document.getElementById("obstacle");
    const message = document.getElementById("message");
    const qrCanvas = document.getElementById("qr");

    let isJumping = false;
    let gameOver = false;
    let velocity = 0;
    const gravity = 0.6;
    const jumpStrength = -12;
    let gameStarted = false;
    let gameLoop = null;

    // QR Code
    const controllerURL = "https://princeagarwalindia.github.io/Website/controller.html";
    QRCode.toCanvas(qrCanvas, controllerURL, (error) => {
      if (error) console.error(error);
    });

    // Controller input
    const channel = new BroadcastChannel("dino-channel");
    channel.onmessage = (e) => {
      if (e.data === "jump") {
        if (gameOver) {
          resetGame();
        } else {
          if (!gameStarted) startGame();
          jump();
        }
      }
    };

    // Spacebar
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        if (gameOver) {
          resetGame();
        } else {
          if (!gameStarted) startGame();
          jump();
        }
      }
    });

    function jump() {
      let currentBottom = parseFloat(player.style.bottom) || 0;
      // Prevent multiple jumps by ensuring isJumping is false
      if (!isJumping && currentBottom <= 0.1) {
        velocity = jumpStrength; // Apply jump strength
        isJumping = true; // Mark as jumping
      }
    }

    function resetGame() {
      if (gameLoop) clearInterval(gameLoop);
      gameOver = false;
      isJumping = false;
      velocity = 0;
      gameStarted = false;
      player.style.bottom = "0px";
      obstacle.style.right = "0px";
      message.textContent = "Scan this QR on your phone to play!";
    }

    function startGame() {
      if (gameStarted) return;
      gameStarted = true;
      let obstaclePos = 0;

      gameLoop = setInterval(() => {
        velocity += gravity; // Apply gravity
        let currentBottom = parseFloat(player.style.bottom) || 0;
        currentBottom += velocity; // Update position

        if (currentBottom <= 0) {
          currentBottom = 0; // Reset to ground level
          velocity = 0; // Stop vertical movement
          isJumping = false; // Allow jumping again
        }

        player.style.bottom = currentBottom + "px";

        obstaclePos += 6; // Move obstacle
        obstacle.style.right = obstaclePos + "px";

        const playerRect = player.getBoundingClientRect();
        const obstacleRect = obstacle.getBoundingClientRect();

        // Check for collision
        if (
          playerRect.left < obstacleRect.right &&
          playerRect.right > obstacleRect.left &&
          playerRect.bottom > obstacleRect.top
        ) {
          clearInterval(gameLoop);
          gameOver = true;
          message.textContent = "Game Over! Tap or press space to restart.";
        }

        // Reset obstacle if it moves off screen
        if (obstaclePos > 600) {
          obstaclePos = 0;
          obstacle.style.right = "0px";
        }
      }, 20);
    }

    resetGame(); // Initial reset
  </script>
</body>
</html>
